<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chatbot</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <style>
        /* Chatbot User & Bot Images */
        .user_img { width: 50px; height: 50px; }
        .user_img_msg { width: 30px; height: 30px; }

        /* Responsive Chat Window */
        @media screen and (max-width: 768px) {
            .chat, .card { width: 100% !important; }
            .type_msg { font-size: 16px; }
        }

        /* Chat Input & Send Button */
        .type_msg { height: 50px; border-radius: 20px; }
        .send_btn { border-radius: 50%; background-color: #007bff; color: white; }
        .send_btn:hover { background-color: #0056b3; }

        /* Chat Container */
        .msg_card_body { overflow-y: auto; height: 400px; }

        /* Code Block Formatting */
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        code { font-family: monospace; color: #d63384; }

        /* File Upload & Camera */
        .upload-btn { margin-top: 10px; }
        video { width: 100%; max-height: 200px; display: none; }
    </style>
</head>

<body>
    <div class="container-fluid h-100">
        <div class="row justify-content-center h-100">
            <div class="col-md-8 col-xl-6 chat">
                <div class="card">
                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight">
                            <div class="img_cont">
                                <img src="https://i.ibb.co/fSNP7Rz/icons8-chatgpt-512.png" class="rounded-circle user_img">
                                <span class="online_icon"></span>
                            </div>
                            <div class="user_info">
                                <span>ChatBot</span>
                                <p>Ask me anything!</p>
                            </div>
                        </div>
                    </div>

                    <div id="messageFormeight" class="card-body msg_card_body"></div>

                    <div class="card-footer">
                        <form id="messageArea" class="input-group">
                            <input type="text" id="text" name="msg" placeholder="Type your message..." 
                                   autocomplete="off" class="form-control type_msg" required/>
                            <div class="input-group-append">
                                <button type="submit" id="send" class="input-group-text send_btn">
                                    <i class="fas fa-location-arrow"></i>
                                </button>
                            </div>
                        </form>

                        <!-- File Upload Buttons -->
                        <input type="file" id="imageUpload" accept="image/*" class="form-control upload-btn">
                        <input type="file" id="docUpload" accept=".pdf,.doc,.docx,.txt" class="form-control upload-btn">

                        <!-- Camera Capture -->
                        <button id="openCamera" class="btn btn-primary btn-sm upload-btn">Open Camera</button>
                        <video id="video" autoplay></video>
                        <button id="capture" class="btn btn-success btn-sm upload-btn">Capture</button>
                        <canvas id="canvas" style="display: none;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
       $(document).ready(function(){
            $("#messageArea").on("submit", function(event){
                event.preventDefault();
                const date = new Date();
                const str_time = date.getHours() + ":" + (date.getMinutes() < 10 ? "0" : "") + date.getMinutes();
                var rawText = $("#text").val().trim();

                if (rawText === "") return;

                var userHtml = '<div class="d-flex justify-content-end mb-4">' +
                               '<div class="msg_cotainer_send">' + rawText + 
                               '<span class="msg_time_send">' + str_time + '</span></div>' +
                               '<div class="img_cont_msg">' +
                               '<img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg"></div></div>';

                $("#messageFormeight").append(userHtml);

                $.ajax({
                    data: { msg: rawText },
                    type: "POST",
                    url: "/get"
                }).done(function(data){
                    var formattedData = data.replace(/([\s\S]*?)/g, '<pre><code>$1</code></pre>');
                    var botHtml = '<div class="d-flex justify-content-start mb-4">' +
                                  '<div class="img_cont_msg">' +
                                  '<img src="https://i.ibb.co/fSNP7Rz/icons8-chatgpt-512.png" class="rounded-circle user_img_msg"></div>' +
                                  '<div class="msg_cotainer">' + formattedData + 
                                  '<span class="msg_time">' + str_time + '</span></div></div>';
                    $("#messageFormeight").append($.parseHTML(botHtml));
                    $("#messageFormeight").scrollTop($("#messageFormeight")[0].scrollHeight);
                });

                $("#text").val("");
            });

            // Image Upload
            $("#imageUpload").change(function(){
                var file = this.files[0];
                var formData = new FormData();
                formData.append("image", file);

                $.ajax({
                    url: "/upload_image",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        $("#messageFormeight").append('<div class="msg_cotainer_send"><img src="' + response.image_url + '" width="100"></div>');
                    }
                });
            });

            // Document Upload
            $("#docUpload").change(function(){
                var file = this.files[0];
                var formData = new FormData();
                formData.append("document", file);

                $.ajax({
                    url: "/upload_doc",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        $("#messageFormeight").append('<div class="msg_cotainer_send">' + response.text + '</div>');
                    }
                });
            });

            // Camera Capture
            $("#openCamera").click(function(){
                navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    $("#video")[0].srcObject = stream;
                    $("#video").show();
                });
            });

            $("#capture").click(function(){
                var canvas = $("#canvas")[0];
                var video = $("#video")[0];
                canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                var dataURL = canvas.toDataURL("image/png");

                $.ajax({
                    url: "/camera_search",
                    type: "POST",
                    data: { image: dataURL },
                    success: function(response) {
                        $("#messageFormeight").append('<div class="msg_cotainer_send">' + response.result + '</div>');
                    }
                });
            });
       });
    </script>
</body>
</html>